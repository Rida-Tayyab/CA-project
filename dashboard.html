<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Global Air Command | Intelligence Center</title>

  <!-- External Libraries -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
  <script
    src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --bg: #050508;
      --panel: #0f1016;
      --border: rgba(148, 163, 184, 0.1);

      /* Blue-Green Combination Scheme */
      --accent: #0abfbc;
      --accent-gradient: linear-gradient(135deg, #0abfbc, #10b981);

      --safe: #00e400;
      --moderate: #22d3ee;
      --unhealthy: #f97316;
      --hazardous: #ef4444;
      --text-main: #f8fafc;
      --text-muted: #94a3b8;
      --shadow-glow: 0 0 20px rgba(10, 191, 188, 0.2);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--bg);
      color: var(--text-main);
      height: 100vh;
      overflow: hidden;
    }

    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      height: 70px;
      background: rgba(15, 16, 22, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 24px;
      flex-shrink: 0;
      z-index: 50;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand h1 {
      font-family: 'Space Grotesk', sans-serif;
      font-size: 18px;
      font-weight: 700;
      letter-spacing: -0.5px;
    }

    .brand-icon {
      width: 40px;
      height: 40px;
      background: var(--accent-gradient);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 14px;
      box-shadow: var(--shadow-glow);
    }

    .search-bar {
      display: flex;
      gap: 8px;
      width: 400px;
    }

    .search-input {
      background: #1a1b26;
      border: 1px solid var(--border);
      color: white;
      padding: 10px 16px;
      border-radius: 8px;
      width: 100%;
      outline: none;
      font-size: 13px;
    }

    .search-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(10, 191, 188, 0.2);
    }

    .btn {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--accent-gradient);
      color: white;
      box-shadow: var(--shadow-glow);
    }

    .btn-primary:hover {
      filter: brightness(1.1);
    }

    .btn-ghost {
      background: transparent;
      border: 1px solid var(--border);
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      border-color: var(--text-main);
      color: var(--text-main);
    }

    .btn-sim {
      background: #1e1e2e;
      border: 1px solid var(--accent);
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-sim.active {
      background: var(--accent);
      color: #000;
      box-shadow: 0 0 15px var(--accent);
    }

    .main-wrapper {
      display: flex;
      flex: 1;
      overflow: hidden;
      position: relative;
    }

    /* SIDEBAR */
    .sidebar {
      width: 320px;
      background: var(--panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 20;
    }

    .sidebar.collapsed {
      width: 0;
      border: none;
    }

    .sidebar.collapsed .sidebar-content {
      opacity: 0;
      pointer-events: none;
    }

    .sidebar-content {
      width: 320px;
      display: flex;
      flex-direction: column;
      height: 100%;
      transition: opacity 0.2s;
    }

    .sidebar-toggle {
      position: absolute;
      top: 20px;
      left: 320px;
      width: 32px;
      height: 32px;
      background: #1e1e2e;
      border: 1px solid var(--border);
      border-radius: 0 8px 8px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-muted);
      transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      z-index: 30;
    }

    .sidebar.collapsed+.content-area .sidebar-toggle {
      left: 0;
    }

    .station-list {
      flex: 1;
      overflow-y: auto;
      padding: 10px;
    }

    .station-item {
      padding: 12px;
      margin-bottom: 8px;
      background: rgba(255, 255, 255, 0.02);
      border-radius: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .station-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(255, 255, 255, 0.1);
    }

    .station-item.active {
      border-color: var(--accent);
      background: rgba(10, 191, 188, 0.1);
    }

    .s-aqi {
      font-weight: 800;
      font-size: 14px;
      width: 30px;
      text-align: center;
    }

    .s-info {
      flex: 1;
      margin-left: 12px;
    }

    .s-name {
      font-size: 12px;
      font-weight: 600;
      color: #fff;
    }

    .s-status {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .content-area {
      flex: 1;
      overflow-y: auto;
      background: #050508;
      position: relative;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    /* SIMULATION CONTROLS (NEW) */
    #simControls {
      background: rgba(10, 191, 188, 0.1);
      border: 1px solid var(--accent);
      padding: 15px;
      border-radius: 12px;
      display: none;
      /* Hidden by default */
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      animation: slideDown 0.3s ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .sim-slider-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .sim-label {
      font-size: 11px;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    input[type=range] {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      background: transparent;
    }

    input[type=range]::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 16px;
      width: 16px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid var(--accent);
      cursor: pointer;
      margin-top: -6px;
      box-shadow: 0 0 10px var(--accent);
    }

    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 4px;
      cursor: pointer;
      background: #333;
      border-radius: 2px;
    }

    .grid-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 16px;
    }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
    }

    .c-label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-muted);
      font-weight: 700;
      letter-spacing: 1px;
    }

    .c-value {
      font-size: 32px;
      font-weight: 800;
      color: white;
      font-family: 'Space Grotesk';
      margin: 8px 0;
    }

    .c-unit {
      font-size: 12px;
      color: var(--text-muted);
      font-family: 'JetBrains Mono';
    }

    .grid-mid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      height: 300px;
    }

    .chart-container {
      position: relative;
      width: 100%;
      height: 100%;
    }

    .esp-container {
      background: #0a0a10;
      border: 1px solid #2a2a35;
      border-radius: 16px;
      padding: 0;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      height: 100%;
      position: relative;
    }

    .esp-container::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 2px;
      background: var(--accent-gradient);
    }

    .esp-head {
      padding: 15px;
      border-bottom: 1px solid #2a2a35;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.02);
    }

    .esp-title {
      font-size: 11px;
      font-weight: 800;
      color: #fff;
      letter-spacing: 1px;
    }

    .esp-leds {
      display: flex;
      gap: 6px;
    }

    .led {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #333;
    }

    .led.active {
      background: #00e400;
      box-shadow: 0 0 8px #00e400;
    }

    .led.warn {
      background: #ef4444;
      box-shadow: 0 0 8px #ef4444;
      animation: blink 1s infinite;
    }

    .esp-body {
      padding: 15px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .telemetry-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .tele-box {
      background: #151520;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #2a2a35;
    }

    .tele-label {
      font-size: 9px;
      color: #666;
      display: block;
      margin-bottom: 4px;
    }

    .tele-val {
      font-family: 'JetBrains Mono';
      font-size: 12px;
      color: var(--accent);
    }

    .terminal {
      background: #000;
      border: 1px solid #333;
      border-radius: 6px;
      flex: 1;
      padding: 10px;
      font-family: 'JetBrains Mono';
      font-size: 10px;
      color: #a9b7c6;
      overflow: hidden;
      opacity: 0.8;
    }

    .terminal-line {
      margin-bottom: 2px;
    }

    .map-wrapper {
      flex: 1;
      min-height: 400px;
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
      position: relative;
    }

    #map {
      width: 100%;
      height: 100%;
      background: #111;
    }

    .custom-tooltip {
      background: rgba(0, 0, 0, 0.85);
      border: 1px solid var(--border);
      color: #fff;
      font-family: 'Inter';
      font-size: 12px;
      padding: 4px 8px;
      border-radius: 4px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5);
    }

    .leaflet-tooltip-left::before {
      border-left-color: rgba(0, 0, 0, 0.85);
    }

    .leaflet-tooltip-right::before {
      border-right-color: rgba(0, 0, 0, 0.85);
    }

    @keyframes blink {
      50% {
        opacity: 0.3;
      }
    }
  </style>
</head>

<body>

  <div class="app-container">

    <div id="authOverlay"
      style="position:fixed; inset:0; background:rgba(0,0,0,0.95); z-index:9999; display:flex; align-items:center; justify-content:center; backdrop-filter:blur(10px);">
      <div
        style="background:#151520; padding:40px; border-radius:24px; width:400px; text-align:center; border:1px solid #333;">
        <h2 style="margin-bottom:10px;">Security Clearance</h2>
        <p style="color:#888; font-size:13px; margin-bottom:20px;">Enter WAQI API Token to access Global Intelligence
        </p>
        <input type="text" id="apiToken" placeholder="Paste Token Here"
          style="width:100%; padding:12px; background:#000; border:1px solid #333; color:white; border-radius:8px; text-align:center; margin-bottom:20px;">
        <button onclick="authenticate()" class="btn btn-primary" style="width:100%">Authenticate</button>
        <a href="https://aqicn.org/data-platform/token/" target="_blank"
          style="display:block; margin-top:15px; font-size:11px; color:var(--accent);">No token? Get one free</a>
      </div>
    </div>

    <header>
      <div class="brand">
        <div class="brand-icon"><i class="fas fa-globe-asia"></i></div>
        <div>
          <h1>Global Air Intelligence</h1>
          <div style="font-size:10px; color:var(--text-muted); letter-spacing:1px; text-transform:uppercase;">Real-Time
            Surveillance</div>
        </div>
      </div>
      <div class="search-bar">
        <input type="text" id="searchInput" class="search-input" placeholder="Search Sector..."
          onkeypress="if(event.key==='Enter') searchLocation()">
        <button class="btn btn-primary" onclick="searchLocation()"><i class="fas fa-search"></i></button>
      </div>
      <div style="display:flex; gap:10px;">
        <button class="btn btn-sim" id="simBtn" onclick="toggleSimulation()">
          <i class="fas fa-plug"></i> CONNECT SIM
        </button>
        <button class="btn btn-ghost" onclick="loadPakistanDefault()"><i class="fas fa-sync-alt"></i></button>
      </div>
    </header>

    <div class="main-wrapper">
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-content">
          <div style="padding:20px; border-bottom:1px solid var(--border);">
            <div style="font-size:11px; font-weight:800; color:var(--text-muted); text-transform:uppercase;">Active
              Stations</div>
            <div style="font-size:24px; font-weight:800; color:white; margin-top:4px;" id="stationCount">0</div>
          </div>
          <div class="station-list" id="stationList"></div>
        </div>
      </aside>

      <div class="sidebar-toggle" id="toggleBtn" onclick="toggleSidebar()"><i class="fas fa-chevron-left"></i></div>

      <main class="content-area">

        <!-- SIMULATION CONTROLS -->
        <div id="simControls">
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: PM2.5 Sensor</label>
            <input type="range" id="simPM" min="0" max="300" value="20" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;"><span>0
                (Safe)</span><span>75 (Mod)</span><span>150 (Hazard)</span><span>300</span></div>
          </div>
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: CO Sensor</label>
            <input type="range" id="simCO" min="0" max="300" value="20" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;"><span>0
                (Safe)</span><span>50 (Mod)</span><span>200 (Hazard)</span><span>300</span></div>
          </div>
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: Temperature</label>
            <input type="range" id="simTemp" min="15" max="35" value="25" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;">
              <span>15°C</span><span>20°C</span><span>30°C</span><span>35°C</span>
            </div>
          </div>
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: Humidity</label>
            <input type="range" id="simHumidity" min="20" max="90" value="50" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;">
              <span>20%</span><span>30%</span><span>70%</span><span>90%</span>
            </div>
          </div>
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: PM10 Sensor</label>
            <input type="range" id="simPM10" min="0" max="200" value="20" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;"><span>0
                (Safe)</span><span>50 (Mod)</span><span>100 (Hazard)</span><span>200</span></div>
          </div>
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: NO2 Sensor</label>
            <input type="range" id="simNO2" min="0" max="300" value="50" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;"><span>0
                (Safe)</span><span>100 (Mod)</span><span>200 (Hazard)</span><span>300</span></div>
          </div>
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: O3 Sensor</label>
            <input type="range" id="simO3" min="0" max="300" value="50" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;"><span>0
                (Safe)</span><span>100 (Mod)</span><span>200 (Hazard)</span><span>300</span></div>
          </div>
          <div class="sim-slider-group">
            <label class="sim-label">Hardware Input: SO2 Sensor</label>
            <input type="range" id="simSO2" min="0" max="200" value="20" oninput="updateSimulatedReadings()">
            <div style="font-size:10px; color:#666; display:flex; justify-content:space-between;"><span>0
                (Safe)</span><span>50 (Mod)</span><span>150 (Hazard)</span><span>200</span></div>
          </div>
        </div>

        <div class="grid-stats">
          <div class="card">
            <div class="c-label">Air Quality Index</div>
            <div class="c-value" id="dispAQI" style="color:var(--safe)">--</div>
            <div class="c-unit" id="dispStatus">Standby</div>
          </div>
          <div class="card">
            <div class="c-label">Particulate Matter</div>
            <div class="c-value" id="dispPM">--</div>
            <div class="c-unit">PM2.5 (µg/m³)</div>
          </div>
          <div class="card">
            <div class="c-label">Carbon Monoxide</div>
            <div class="c-value" id="dispCO">--</div>
            <div class="c-unit">Parts Per Million</div>
          </div>
          <div class="card">
            <div class="c-label">Temperature</div>
            <div class="c-value" id="dispTemp">--</div>
            <div class="c-unit">Celsius (°C)</div>
          </div>
          <div class="card">
            <div class="c-label">Humidity</div>
            <div class="c-value" id="dispHumidity">--</div>
            <div class="c-unit">Relative Humidity (%)</div>
          </div>
          <div class="card">
            <div class="c-label">PM10</div>
            <div class="c-value" id="dispPM10">--</div>
            <div class="c-unit">PM10 (µg/m³)</div>
          </div>
          <div class="card">
            <div class="c-label">Nitrogen Dioxide</div>
            <div class="c-value" id="dispNO2">--</div>
            <div class="c-unit">NO2 (µg/m³)</div>
          </div>
          <div class="card">
            <div class="c-label">Ozone</div>
            <div class="c-value" id="dispO3">--</div>
            <div class="c-unit">O3 (µg/m³)</div>
          </div>
          <div class="card">
            <div class="c-label">Sulfur Dioxide</div>
            <div class="c-value" id="dispSO2">--</div>
            <div class="c-unit">SO2 (µg/m³)</div>
          </div>
        </div>

        <div class="grid-mid">
          <div class="card" style="padding:10px;">
            <div class="chart-container">
              <canvas id="aqiChart"></canvas>
            </div>
          </div>

          <div class="esp-container">
            <div class="esp-head">
              <span class="esp-title"><i class="fas fa-microchip"></i> ESP32-S3 EDGE NODE</span>
              <div class="esp-leds">
                <div class="led active" id="ledPwr" title="Power: System Online"></div>
                <div class="led" id="ledWifi" title="Network: API Connected"></div>
                <div class="led" id="ledWarn" title="Alarm: Critical Hazard Detected"></div>
                <div class="led" id="ledFan" title="Fan: PM2.5 Control" style="background:#333;"></div>
                <div class="led" id="ledVent" title="Ventilation: CO/Humidity/Temp Control" style="background:#333;">
                </div>
                <div class="led" id="ledPurifier" title="Purifier: NO2/O3/SO2 Control" style="background:#333;"></div>
              </div>
            </div>
            <div class="esp-body">
              <div class="telemetry-row">
                <div class="tele-box">
                  <span class="tele-label">UPTIME</span>
                  <span class="tele-val">42:10:05</span>
                </div>
                <div class="tele-box">
                  <span class="tele-label">AQI</span>
                  <span class="tele-val" id="espAQI">--</span>
                </div>
              </div>
              <div class="telemetry-row" style="margin-top:8px;">
                <div class="tele-box">
                  <span class="tele-label">ALARM</span>
                  <span class="tele-val" id="periphAlarm" style="color:#0abfbc;">OFF</span>
                </div>
                <div class="tele-box">
                  <span class="tele-label">FAN</span>
                  <span class="tele-val" id="periphFan" style="color:#0abfbc;">OFF</span>
                </div>
              </div>
              <div class="telemetry-row" style="margin-top:8px;">
                <div class="tele-box">
                  <span class="tele-label">VENTILATION</span>
                  <span class="tele-val" id="periphVent" style="color:#0abfbc;">OFF</span>
                </div>
                <div class="tele-box">
                  <span class="tele-label">PURIFIER</span>
                  <span class="tele-val" id="periphPurifier" style="color:#0abfbc;">OFF</span>
                </div>
              </div>
              <div class="terminal" id="terminalOutput">
                <div class="terminal-line">> SYSTEM_INIT... OK</div>
                <div class="terminal-line">> SENSORS_CALIB... OK</div>
                <div class="terminal-line">> WAITING_FOR_DATA...</div>
              </div>
              <div style="font-size:9px; color:#555; text-align:right;">FW: v2.4.1 | CORE: 1</div>
            </div>
          </div>
        </div>

        <div class="map-wrapper">
          <div id="map"></div>
        </div>

      </main>
    </div>
  </div>

  <script>
    const DEFAULT_CITIES = ['Islamabad', 'Karachi', 'Lahore', 'Peshawar', 'Quetta', 'Rawalpindi', 'Multan'];
    let TOKEN = localStorage.getItem('waqi_token');
    let map, markersLayer, chart;
    let currentStations = [];
    let isSimulating = false;

    // === CONSTANTS (Matches Assembly/C++ Logic Exactly) ===
    const PM_SAFE_LIMIT = 75;
    const PM_HAZARD_LIMIT = 150;
    const PM10_SAFE_LIMIT = 50;
    const PM10_HAZARD_LIMIT = 100;
    const CO_SAFE_LIMIT = 50;
    const CO_HAZARD_LIMIT = 200;
    const NO2_SAFE_LIMIT = 100;
    const NO2_HAZARD_LIMIT = 200;
    const O3_SAFE_LIMIT = 100;
    const O3_HAZARD_LIMIT = 200;
    const SO2_SAFE_LIMIT = 50;
    const SO2_HAZARD_LIMIT = 150;
    const TEMP_LOW_LIMIT = 20;
    const TEMP_HIGH_LIMIT = 30;
    const HUMIDITY_LOW_LIMIT = 30;
    const HUMIDITY_HIGH_LIMIT = 70;

    window.onload = function () {
      initMap();
      initChart();
      if (TOKEN) {
        document.getElementById('apiToken').value = TOKEN;
        authenticate();
      }
    };

    function initMap() {
      map = L.map('map').setView([30.3753, 69.3451], 5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; OpenStreetMap &copy; CARTO', maxZoom: 19
      }).addTo(map);
      markersLayer = L.layerGroup().addTo(map);
    }

    function initChart() {
      const ctx = document.getElementById('aqiChart').getContext('2d');

      // Create gradients for each pollutant
      const createGradient = (color, opacity = 0.3) => {
        const grad = ctx.createLinearGradient(0, 0, 0, 300);
        grad.addColorStop(0, color.replace('rgb', 'rgba').replace(')', `, ${opacity})`));
        grad.addColorStop(1, color.replace('rgb', 'rgba').replace(')', ', 0.0)'));
        return grad;
      };

      chart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: [],
          datasets: [
            { label: 'PM2.5 (µg/m³)', data: [], borderColor: '#10b981', backgroundColor: createGradient('rgb(16, 185, 129)', 0.3), borderWidth: 2, fill: true, tension: 0.4, pointRadius: 2 },
            { label: 'PM10 (µg/m³)', data: [], borderColor: '#22d3ee', backgroundColor: createGradient('rgb(34, 211, 238)', 0.2), borderWidth: 2, fill: true, tension: 0.4, pointRadius: 2 },
            { label: 'CO (ppm)', data: [], borderColor: '#0abfbc', backgroundColor: createGradient('rgb(10, 191, 188)', 0.3), borderWidth: 2, fill: true, tension: 0.4, pointRadius: 2 },
            { label: 'NO2 (µg/m³)', data: [], borderColor: '#f97316', backgroundColor: createGradient('rgb(249, 115, 22)', 0.2), borderWidth: 2, fill: true, tension: 0.4, pointRadius: 2 },
            { label: 'O3 (µg/m³)', data: [], borderColor: '#8b5cf6', backgroundColor: createGradient('rgb(139, 92, 246)', 0.2), borderWidth: 2, fill: true, tension: 0.4, pointRadius: 2 },
            { label: 'SO2 (µg/m³)', data: [], borderColor: '#ec4899', backgroundColor: createGradient('rgb(236, 72, 153)', 0.2), borderWidth: 2, fill: true, tension: 0.4, pointRadius: 2 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: {
            mode: 'index',
            intersect: false,
          },
          plugins: {
            legend: {
              display: true,
              labels: {
                color: '#94a3b8',
                font: { family: 'Inter', size: 10 },
                usePointStyle: true,
                padding: 8
              },
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false,
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: '#fff',
              bodyColor: '#fff',
              borderColor: 'rgba(255, 255, 255, 0.1)',
              borderWidth: 1
            }
          },
          scales: {
            x: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#666', maxTicksLimit: 8 }
            },
            y: {
              grid: { color: 'rgba(255,255,255,0.05)' },
              ticks: { color: '#666' },
              beginAtZero: true
            }
          }
        }
      });
    }

    async function authenticate() {
      const token = document.getElementById('apiToken').value.trim();
      if (!token) return;
      try {
        const res = await fetch(`https://api.waqi.info/feed/here/?token=${token}`);
        const data = await res.json();
        if (data.status === 'ok') {
          TOKEN = token;
          localStorage.setItem('waqi_token', token);
          document.getElementById('authOverlay').style.display = 'none';
          loadPakistanDefault();
        } else { alert('Invalid Token'); }
      } catch (e) { alert('Connection Error'); }
    }

    async function loadPakistanDefault() {
      if (isSimulating) toggleSimulation();
      logToTerminal("FETCHING_PAKISTAN_GRID...");
      markersLayer.clearLayers();
      currentStations = [];

      const promises = DEFAULT_CITIES.map(city =>
        fetch(`https://api.waqi.info/feed/${city}/?token=${TOKEN}`).then(r => r.json())
      );
      const results = await Promise.all(promises);
      results.forEach(res => { if (res.status === 'ok') currentStations.push(res.data); });

      renderMapAndList(currentStations);
      if (currentStations.length > 0) updateDashboard(currentStations[0]);
      map.flyTo([30.3753, 69.3451], 5.5, { duration: 2 });
    }

    async function searchLocation() {
      if (isSimulating) toggleSimulation();
      const query = document.getElementById('searchInput').value;
      if (!query) return;

      logToTerminal(`SEARCHING_GLOBAL_DB: "${query}"`);
      const res = await fetch(`https://api.waqi.info/search/?keyword=${query}&token=${TOKEN}`);
      const data = await res.json();

      if (data.status === 'ok' && data.data.length > 0) {
        const topStations = data.data.slice(0, 15);
        const detailPromises = topStations.map(s => fetch(`https://api.waqi.info/feed/@${s.uid}/?token=${TOKEN}`).then(r => r.json()));
        const details = await Promise.all(detailPromises);
        currentStations = details.filter(d => d.status === 'ok').map(d => d.data);

        renderMapAndList(currentStations);
        if (currentStations.length > 0) {
          updateDashboard(currentStations[0]);
          if (currentStations[0].city.geo) map.flyTo(currentStations[0].city.geo, 10);
        }
      } else { logToTerminal("ERROR: NO_DATA_FOUND"); }
    }

    // --- WOKWI MANUAL SYNC LOGIC ---
    function toggleSimulation() {
      isSimulating = !isSimulating;
      const btn = document.getElementById('simBtn');
      const controls = document.getElementById('simControls');

      if (isSimulating) {
        btn.classList.add('active');
        btn.innerHTML = '<i class="fas fa-link"></i> LINK ACTIVE';
        controls.style.display = 'grid'; // Show Sliders
        logToTerminal("INITIATING_DIGITAL_TWIN...");
        logToTerminal("MANUAL_SYNC_INTERFACE_READY...");

        markersLayer.clearLayers();
        // Initialize sliders with default values
        document.getElementById('simPM').value = 20;
        document.getElementById('simPM10').value = 20;
        document.getElementById('simCO').value = 20;
        document.getElementById('simNO2').value = 50;
        document.getElementById('simO3').value = 50;
        document.getElementById('simSO2').value = 20;
        document.getElementById('simTemp').value = 25;
        document.getElementById('simHumidity').value = 50;
        updateSimulatedReadings(); // Run once to set initial state

      } else {
        btn.classList.remove('active');
        btn.innerHTML = '<i class="fas fa-plug"></i> CONNECT SIM';
        controls.style.display = 'none'; // Hide Sliders
        logToTerminal("SIMULATION_ENDED. RESTORING_CLOUD_DATA...");
        loadPakistanDefault();
      }
    }

    function updateSimulatedReadings() {
      if (!isSimulating) return;

      // 1. Get values from Sliders (Manual Input Controls)
      const pm25 = parseInt(document.getElementById('simPM').value);
      const pm10 = parseInt(document.getElementById('simPM10').value);
      const co = parseInt(document.getElementById('simCO').value);
      const no2 = parseInt(document.getElementById('simNO2').value);
      const o3 = parseInt(document.getElementById('simO3').value);
      const so2 = parseInt(document.getElementById('simSO2').value);
      const temp = parseFloat(document.getElementById('simTemp').value);
      const humidity = parseFloat(document.getElementById('simHumidity').value);

      // 2. Logic Classification (EXACTLY matches Assembly/C++ Logic)
      let pmStatus = "SAFE";
      if (pm25 >= PM_HAZARD_LIMIT) pmStatus = "HAZARD";
      else if (pm25 >= PM_SAFE_LIMIT) pmStatus = "MODERATE";

      let pm10Status = "SAFE";
      if (pm10 >= PM10_HAZARD_LIMIT) pm10Status = "HAZARD";
      else if (pm10 >= PM10_SAFE_LIMIT) pm10Status = "MODERATE";

      let coStatus = "SAFE";
      if (co >= CO_HAZARD_LIMIT) coStatus = "HAZARD";
      else if (co >= CO_SAFE_LIMIT) coStatus = "MODERATE";

      let no2Status = "SAFE";
      if (no2 >= NO2_HAZARD_LIMIT) no2Status = "HAZARD";
      else if (no2 >= NO2_SAFE_LIMIT) no2Status = "MODERATE";

      let o3Status = "SAFE";
      if (o3 >= O3_HAZARD_LIMIT) o3Status = "HAZARD";
      else if (o3 >= O3_SAFE_LIMIT) o3Status = "MODERATE";

      let so2Status = "SAFE";
      if (so2 >= SO2_HAZARD_LIMIT) so2Status = "HAZARD";
      else if (so2 >= SO2_SAFE_LIMIT) so2Status = "MODERATE";

      let tempStatus = "SAFE";
      if (temp >= TEMP_HIGH_LIMIT) tempStatus = "HAZARD";
      else if (temp < TEMP_LOW_LIMIT) tempStatus = "MODERATE";

      let humidityStatus = "SAFE";
      if (humidity >= HUMIDITY_HIGH_LIMIT) humidityStatus = "HAZARD";
      else if (humidity < HUMIDITY_LOW_LIMIT) humidityStatus = "MODERATE";

      // 3. Update HTML Elements
      document.getElementById('dispPM').innerText = pm25;
      document.getElementById('dispPM10').innerText = pm10;
      document.getElementById('dispCO').innerText = co;
      document.getElementById('dispNO2').innerText = no2;
      document.getElementById('dispO3').innerText = o3;
      document.getElementById('dispSO2').innerText = so2;
      document.getElementById('dispTemp').innerText = temp.toFixed(1);
      document.getElementById('dispHumidity').innerText = humidity.toFixed(0);

      // Calculate overall AQI (worst case determines overall status)
      let overallStatus = "SAFE";
      let overallColor = '#00e400'; // Safe (green)

      if (pmStatus === "HAZARD" || pm10Status === "HAZARD" || coStatus === "HAZARD" ||
        no2Status === "HAZARD" || o3Status === "HAZARD" || so2Status === "HAZARD" ||
        tempStatus === "HAZARD" || humidityStatus === "HAZARD") {
        overallStatus = "HAZARDOUS";
        overallColor = '#ef4444'; // Hazardous (red)
      } else if (pmStatus === "MODERATE" || pm10Status === "MODERATE" || coStatus === "MODERATE" ||
        no2Status === "MODERATE" || o3Status === "MODERATE" || so2Status === "MODERATE" ||
        tempStatus === "MODERATE" || humidityStatus === "MODERATE") {
        overallStatus = "MODERATE";
        overallColor = '#22d3ee'; // Moderate (cyan)
      }

      // Calculate AQI value (simplified - based on worst sensor)
      let aqiValue = Math.max(pm25, pm10, co * 2, no2, o3, so2,
        temp >= TEMP_HIGH_LIMIT ? 200 : 0,
        humidity >= HUMIDITY_HIGH_LIMIT ? 200 : 0);
      document.getElementById('dispAQI').innerText = aqiValue;
      document.getElementById('dispAQI').style.color = overallColor;
      document.getElementById('dispStatus').innerText = overallStatus;

      // === AQI CALCULATION LOGGING ===
      const aqiComponents = [];
      aqiComponents.push(`PM2.5:${pm25}`);
      aqiComponents.push(`PM10:${pm10}`);
      aqiComponents.push(`CO:${co * 2}`);
      aqiComponents.push(`NO2:${no2}`);
      aqiComponents.push(`O3:${o3}`);
      aqiComponents.push(`SO2:${so2}`);
      if (temp >= TEMP_HIGH_LIMIT) aqiComponents.push(`TEMP_HIGH:200`);
      if (humidity >= HUMIDITY_HIGH_LIMIT) aqiComponents.push(`HUMIDITY_HIGH:200`);

      logToTerminal(`AQI_CALC: [${aqiComponents.join(', ')}] → MAX=${aqiValue} [${overallStatus}]`);

      // 4. Actuators (LEDs) - EXACTLY matches Assembly/C++ Logic
      document.getElementById('espAQI').innerText = aqiValue || '--';

      const alarmLed = document.getElementById('ledWarn');
      const fanLed = document.getElementById('ledFan');
      const ventLed = document.getElementById('ledVent');
      const purifierLed = document.getElementById('ledPurifier');

      // ALARM LOGIC: ON if ANY sensor is HAZARDOUS
      const alarmReason = [];
      if (pmStatus === "HAZARD") alarmReason.push("PM2.5");
      if (pm10Status === "HAZARD") alarmReason.push("PM10");
      if (coStatus === "HAZARD") alarmReason.push("CO");
      if (no2Status === "HAZARD") alarmReason.push("NO2");
      if (o3Status === "HAZARD") alarmReason.push("O3");
      if (so2Status === "HAZARD") alarmReason.push("SO2");
      if (tempStatus === "HAZARD") alarmReason.push("TEMP");
      if (humidityStatus === "HAZARD") alarmReason.push("HUMIDITY");

      if (alarmReason.length > 0) {
        alarmLed.classList.add('warn');
        document.getElementById('periphAlarm').innerText = "ON";
        document.getElementById('periphAlarm').style.color = "#ef4444";
        logToTerminal(`ALARM_ON: Triggered by [${alarmReason.join(', ')}]`);
      } else {
        alarmLed.classList.remove('warn');
        document.getElementById('periphAlarm').innerText = "OFF";
        document.getElementById('periphAlarm').style.color = "#0abfbc";
      }

      // FAN LOGIC: ON if PM2.5 is MODERATE or HAZARDOUS
      if (pmStatus !== "SAFE") {
        fanLed.style.background = "#00e400";
        fanLed.style.boxShadow = "0 0 8px #00e400";
        document.getElementById('periphFan').innerText = "ON";
        document.getElementById('periphFan').style.color = "#00e400";
        logToTerminal(`FAN_ON: PM2.5=${pm25} [${pmStatus}] exceeds safe limit`);
      } else {
        fanLed.style.background = "#333";
        fanLed.style.boxShadow = "none";
        document.getElementById('periphFan').innerText = "OFF";
        document.getElementById('periphFan').style.color = "#0abfbc";
      }

      // VENTILATION LOGIC: ON if CO is MOD/HAZ or Humidity is HIGH or Temp is HIGH
      const ventReason = [];
      if (coStatus !== "SAFE") ventReason.push(`CO:${co}[${coStatus}]`);
      if (humidityStatus === "HAZARD") ventReason.push(`HUMIDITY:${humidity}[${humidityStatus}]`);
      if (tempStatus === "HAZARD") ventReason.push(`TEMP:${temp}[${tempStatus}]`);

      if (ventReason.length > 0) {
        ventLed.style.background = "#0abfbc";
        ventLed.style.boxShadow = "0 0 8px #0abfbc";
        document.getElementById('periphVent').innerText = "ON";
        document.getElementById('periphVent').style.color = "#0abfbc";
        logToTerminal(`VENT_ON: Triggered by [${ventReason.join(', ')}]`);
      } else {
        ventLed.style.background = "#333";
        ventLed.style.boxShadow = "none";
        document.getElementById('periphVent').innerText = "OFF";
        document.getElementById('periphVent').style.color = "#0abfbc";
      }

      // PURIFIER LOGIC: ON if NO2, O3, or SO2 is MODERATE or HAZARDOUS
      const purifierReason = [];
      if (no2Status !== "SAFE") purifierReason.push(`NO2:${no2}[${no2Status}]`);
      if (o3Status !== "SAFE") purifierReason.push(`O3:${o3}[${o3Status}]`);
      if (so2Status !== "SAFE") purifierReason.push(`SO2:${so2}[${so2Status}]`);

      if (purifierReason.length > 0) {
        purifierLed.style.background = "#22d3ee";
        purifierLed.style.boxShadow = "0 0 8px #22d3ee";
        document.getElementById('periphPurifier').innerText = "ON";
        document.getElementById('periphPurifier').style.color = "#22d3ee";
        logToTerminal(`PURIFIER_ON: Triggered by [${purifierReason.join(', ')}]`);
      } else {
        purifierLed.style.background = "#333";
        purifierLed.style.boxShadow = "none";
        document.getElementById('periphPurifier').innerText = "OFF";
        document.getElementById('periphPurifier').style.color = "#0abfbc";
      }

      // Update Chart
      const time = new Date().toLocaleTimeString();
      if (chart.data.labels.length > 15) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift(); // PM2.5
        chart.data.datasets[1].data.shift(); // PM10
        chart.data.datasets[2].data.shift(); // CO
        chart.data.datasets[3].data.shift(); // NO2
        chart.data.datasets[4].data.shift(); // O3
        chart.data.datasets[5].data.shift(); // SO2
      }
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(pm25);      // PM2.5
      chart.data.datasets[1].data.push(pm10);      // PM10
      chart.data.datasets[2].data.push(co);        // CO
      chart.data.datasets[3].data.push(no2);       // NO2
      chart.data.datasets[4].data.push(o3);         // O3
      chart.data.datasets[5].data.push(so2);       // SO2
      chart.update();
    }

    // --- RENDERING ---
    function renderMapAndList(stations) {
      const listEl = document.getElementById('stationList');
      listEl.innerHTML = '';
      document.getElementById('stationCount').innerText = stations.length;
      markersLayer.clearLayers();

      stations.forEach((station, index) => {
        const aqi = parseInt(station.aqi);
        const pm25 = station.iaqi.pm25 ? station.iaqi.pm25.v : 0;
        const lat = station.city.geo[0];
        const lng = station.city.geo[1];

        // Apply Assembly/C++ Logic for Color (PM2.5 classification)
        let color = '#00e400'; // SAFE
        let status = 'SAFE';
        if (pm25 >= PM_HAZARD_LIMIT) {
          color = '#ef4444'; // HAZARD
          status = 'HAZARDOUS';
        } else if (pm25 >= PM_SAFE_LIMIT) {
          color = '#22d3ee'; // MODERATE
          status = 'MODERATE';
        }

        const regionCircle = L.circle([lat, lng], {
          color: color, fillColor: color, fillOpacity: 0.3, radius: 8000, weight: 1
        }).addTo(markersLayer);

        const pin = L.circleMarker([lat, lng], {
          radius: 6, fillColor: color, color: '#fff', weight: 2, fillOpacity: 1
        }).addTo(markersLayer);

        const tooltipContent = `<div style="text-align:center"><b>${station.city.name}</b><br>PM2.5: ${pm25} [${status}]</div>`;
        regionCircle.bindTooltip(tooltipContent, { className: 'custom-tooltip', direction: 'top' });
        pin.bindTooltip(tooltipContent, { className: 'custom-tooltip', direction: 'top' });

        const handleClick = () => {
          map.flyTo([lat, lng], 12, { duration: 1.5 });
          updateDashboard(station);
          highlightListItem(index);
        };

        regionCircle.on('click', handleClick);
        pin.on('click', handleClick);

        const item = document.createElement('div');
        item.className = 'station-item';
        item.id = `item-${index}`;
        item.innerHTML = `
      <div style="display:flex; align-items:center;">
        <div class="s-aqi" style="color:${color}">${pm25}</div>
        <div class="s-info">
          <div class="s-name">${station.city.name.substring(0, 25)}...</div>
          <div class="s-status" style="color:${color}">${status}</div>
        </div>
      </div>
      <i class="fas fa-chevron-right" style="font-size:10px; color:#444;"></i>
    `;
        item.onclick = handleClick;
        listEl.appendChild(item);
      });
    }

    function updateDashboard(data) {
      if (!data) return;

      // Extract real-time sensor values from API
      const pm25Raw = data.iaqi.pm25 ? data.iaqi.pm25.v : 0;
      const pm10Raw = data.iaqi.pm10 ? data.iaqi.pm10.v : null;
      const coRaw = data.iaqi.co ? data.iaqi.co.v : null;  // CO from API (carbon monoxide)
      const no2Raw = data.iaqi.no2 ? data.iaqi.no2.v : null;  // NO2 from API
      const o3Raw = data.iaqi.o3 ? data.iaqi.o3.v : null;  // O3 from API
      const so2Raw = data.iaqi.so2 ? data.iaqi.so2.v : null;  // SO2 from API
      const tempRaw = data.iaqi.t ? data.iaqi.t.v : null;
      const humidityRaw = data.iaqi.h ? data.iaqi.h.v : null;  // Humidity from API

      const pm25Val = Number(pm25Raw);
      const pm10Val = pm10Raw !== null ? Number(pm10Raw) : null;
      const coVal = coRaw !== null ? Number(coRaw) : null;
      const no2Val = no2Raw !== null ? Number(no2Raw) : null;
      const o3Val = o3Raw !== null ? Number(o3Raw) : null;
      const so2Val = so2Raw !== null ? Number(so2Raw) : null;
      const tempVal = tempRaw !== null ? Number(tempRaw) : 25.0;  // Default 25 if not available
      const humidityVal = humidityRaw !== null ? Number(humidityRaw) : 50.0;  // Default 50% if not available

      // === CLASSIFICATION LOGIC (EXACTLY matches Assembly/C++ Logic) ===

      // PM2.5 Status Classification
      let pmStatus = "SAFE";
      if (pm25Val >= PM_HAZARD_LIMIT) pmStatus = "HAZARD";
      else if (pm25Val >= PM_SAFE_LIMIT) pmStatus = "MODERATE";

      // PM10 Status Classification
      let pm10Status = "N/A";
      if (pm10Val !== null) {
        pm10Status = "SAFE";
        if (pm10Val >= PM10_HAZARD_LIMIT) pm10Status = "HAZARD";
        else if (pm10Val >= PM10_SAFE_LIMIT) pm10Status = "MODERATE";
      }

      // CO Status Classification (using CO thresholds, not CO2)
      let coStatus = "N/A";
      if (coVal !== null) {
        coStatus = "SAFE";
        if (coVal >= CO_HAZARD_LIMIT) coStatus = "HAZARD";
        else if (coVal >= CO_SAFE_LIMIT) coStatus = "MODERATE";
      }

      // NO2 Status Classification
      let no2Status = "N/A";
      if (no2Val !== null) {
        no2Status = "SAFE";
        if (no2Val >= NO2_HAZARD_LIMIT) no2Status = "HAZARD";
        else if (no2Val >= NO2_SAFE_LIMIT) no2Status = "MODERATE";
      }

      // O3 Status Classification
      let o3Status = "N/A";
      if (o3Val !== null) {
        o3Status = "SAFE";
        if (o3Val >= O3_HAZARD_LIMIT) o3Status = "HAZARD";
        else if (o3Val >= O3_SAFE_LIMIT) o3Status = "MODERATE";
      }

      // SO2 Status Classification
      let so2Status = "N/A";
      if (so2Val !== null) {
        so2Status = "SAFE";
        if (so2Val >= SO2_HAZARD_LIMIT) so2Status = "HAZARD";
        else if (so2Val >= SO2_SAFE_LIMIT) so2Status = "MODERATE";
      }

      // Temperature Status Classification
      let tempStatus = "SAFE";
      if (tempVal >= TEMP_HIGH_LIMIT) tempStatus = "HAZARD";
      else if (tempVal < TEMP_LOW_LIMIT) tempStatus = "MODERATE";

      // Humidity Status Classification
      let humidityStatus = "SAFE";
      if (humidityVal >= HUMIDITY_HIGH_LIMIT) humidityStatus = "HAZARD";
      else if (humidityVal < HUMIDITY_LOW_LIMIT) humidityStatus = "MODERATE";

      // Determine overall status and color (worst case determines overall)
      let overallStatus = "SAFE";
      let color = 'var(--safe)';

      if (pmStatus === "HAZARD" || pm10Status === "HAZARD" || coStatus === "HAZARD" ||
        no2Status === "HAZARD" || o3Status === "HAZARD" || so2Status === "HAZARD" ||
        tempStatus === "HAZARD" || humidityStatus === "HAZARD") {
        overallStatus = "HAZARDOUS";
        color = 'var(--hazardous)';
      } else if (pmStatus === "MODERATE" || pm10Status === "MODERATE" || coStatus === "MODERATE" ||
        no2Status === "MODERATE" || o3Status === "MODERATE" || so2Status === "MODERATE" ||
        tempStatus === "MODERATE" || humidityStatus === "MODERATE") {
        overallStatus = "MODERATE";
        color = 'var(--moderate)';
      }

      // Calculate AQI value (based on worst sensor)
      let aqiValue = Math.max(
        pm25Val,
        pm10Val !== null ? pm10Val : 0,
        coVal !== null ? coVal * 2 : 0,
        no2Val !== null ? no2Val : 0,
        o3Val !== null ? o3Val : 0,
        so2Val !== null ? so2Val : 0,
        tempVal >= TEMP_HIGH_LIMIT ? 200 : 0,
        humidityVal >= HUMIDITY_HIGH_LIMIT ? 200 : 0
      );

      // Update Display
      document.getElementById('dispAQI').innerText = aqiValue || data.aqi;
      document.getElementById('dispAQI').style.color = color;
      document.getElementById('dispStatus').innerText = overallStatus;

      // Update display with better handling of missing data
      document.getElementById('dispPM').innerText = pm25Val || '--';

      // Show N/A with a note that data isn't available from this station
      const showNA = (val, id) => {
        if (val !== null) {
          document.getElementById(id).innerText = val;
          document.getElementById(id).style.color = 'white';
        } else {
          document.getElementById(id).innerText = 'N/A';
          document.getElementById(id).style.color = '#666';
          document.getElementById(id).title = 'Data not available from this monitoring station';
        }
      };

      showNA(pm10Val, 'dispPM10');
      showNA(coVal, 'dispCO');
      showNA(no2Val, 'dispNO2');
      showNA(o3Val, 'dispO3');
      showNA(so2Val, 'dispSO2');

      document.getElementById('dispTemp').innerText = tempVal.toFixed(1);
      document.getElementById('dispHumidity').innerText = humidityVal.toFixed(0);

      // === AQI CALCULATION LOGGING ===
      const aqiComponents = [];
      aqiComponents.push(`PM2.5:${pm25Val}`);
      if (pm10Val !== null) aqiComponents.push(`PM10:${pm10Val}`);
      if (coVal !== null) aqiComponents.push(`CO:${coVal * 2}`);
      if (no2Val !== null) aqiComponents.push(`NO2:${no2Val}`);
      if (o3Val !== null) aqiComponents.push(`O3:${o3Val}`);
      if (so2Val !== null) aqiComponents.push(`SO2:${so2Val}`);
      if (tempVal >= TEMP_HIGH_LIMIT) aqiComponents.push(`TEMP_HIGH:200`);
      if (humidityVal >= HUMIDITY_HIGH_LIMIT) aqiComponents.push(`HUMIDITY_HIGH:200`);

      logToTerminal(`AQI_CALC: [${aqiComponents.join(', ')}] → MAX=${aqiValue} [${overallStatus}]`);

      // === ACTUATOR LOGIC (EXACTLY matches Assembly/C++ Logic) ===
      document.getElementById('ledWifi').classList.add('active');
      document.getElementById('espAQI').innerText = aqiValue || data.aqi || '--';

      // ALARM: ON if ANY sensor is HAZARDOUS
      const ledWarn = document.getElementById('ledWarn');
      const alarmReason = [];
      if (pmStatus === "HAZARD") alarmReason.push("PM2.5");
      if (pm10Status === "HAZARD") alarmReason.push("PM10");
      if (coStatus === "HAZARD") alarmReason.push("CO");
      if (no2Status === "HAZARD") alarmReason.push("NO2");
      if (o3Status === "HAZARD") alarmReason.push("O3");
      if (so2Status === "HAZARD") alarmReason.push("SO2");
      if (tempStatus === "HAZARD") alarmReason.push("TEMP");
      if (humidityStatus === "HAZARD") alarmReason.push("HUMIDITY");

      if (alarmReason.length > 0) {
        ledWarn.classList.add('warn');
        document.getElementById('periphAlarm').innerText = "ON";
        document.getElementById('periphAlarm').style.color = "#ef4444";
        logToTerminal(`ALARM_ON: Triggered by [${alarmReason.join(', ')}]`);
      } else {
        ledWarn.classList.remove('warn');
        document.getElementById('periphAlarm').innerText = "OFF";
        document.getElementById('periphAlarm').style.color = "#0abfbc";
      }

      // FAN: ON if PM2.5 is MODERATE or HAZARDOUS (matches Assembly logic)
      const fanLed = document.getElementById('ledFan');
      if (pmStatus !== "SAFE") {
        fanLed.style.background = "#00e400";
        fanLed.style.boxShadow = "0 0 8px #00e400";
        document.getElementById('periphFan').innerText = "ON";
        document.getElementById('periphFan').style.color = "#00e400";
        logToTerminal(`FAN_ON: PM2.5=${pm25Val} [${pmStatus}] exceeds safe limit`);
      } else {
        fanLed.style.background = "#333";
        fanLed.style.boxShadow = "none";
        document.getElementById('periphFan').innerText = "OFF";
        document.getElementById('periphFan').style.color = "#0abfbc";
      }

      // VENTILATION: ON if CO is MOD/HAZ or Humidity is HIGH or Temp is HIGH
      const ventLed = document.getElementById('ledVent');
      const ventReason = [];
      if (coStatus !== "SAFE" && coStatus !== "N/A") ventReason.push(`CO:${coVal}[${coStatus}]`);
      if (humidityStatus === "HAZARD") ventReason.push(`HUMIDITY:${humidityVal}[${humidityStatus}]`);
      if (tempStatus === "HAZARD") ventReason.push(`TEMP:${tempVal}[${tempStatus}]`);

      if (ventReason.length > 0) {
        ventLed.style.background = "#0abfbc";
        ventLed.style.boxShadow = "0 0 8px #0abfbc";
        document.getElementById('periphVent').innerText = "ON";
        document.getElementById('periphVent').style.color = "#0abfbc";
        logToTerminal(`VENT_ON: Triggered by [${ventReason.join(', ')}]`);
      } else {
        ventLed.style.background = "#333";
        ventLed.style.boxShadow = "none";
        document.getElementById('periphVent').innerText = "OFF";
        document.getElementById('periphVent').style.color = "#0abfbc";
      }

      // PURIFIER: ON if NO2, O3, or SO2 is MODERATE or HAZARDOUS
      const purifierLed = document.getElementById('ledPurifier');
      const purifierReason = [];
      if (no2Status !== "SAFE" && no2Status !== "N/A") purifierReason.push(`NO2:${no2Val}[${no2Status}]`);
      if (o3Status !== "SAFE" && o3Status !== "N/A") purifierReason.push(`O3:${o3Val}[${o3Status}]`);
      if (so2Status !== "SAFE" && so2Status !== "N/A") purifierReason.push(`SO2:${so2Val}[${so2Status}]`);

      if (purifierReason.length > 0) {
        purifierLed.style.background = "#22d3ee";
        purifierLed.style.boxShadow = "0 0 8px #22d3ee";
        document.getElementById('periphPurifier').innerText = "ON";
        document.getElementById('periphPurifier').style.color = "#22d3ee";
        logToTerminal(`PURIFIER_ON: Triggered by [${purifierReason.join(', ')}]`);
      } else {
        purifierLed.style.background = "#333";
        purifierLed.style.boxShadow = "none";
        document.getElementById('periphPurifier').innerText = "OFF";
        document.getElementById('periphPurifier').style.color = "#0abfbc";
      }

      // Log sensor data
      const sensorData = [];
      sensorData.push(`PM2.5:${pm25Val}[${pmStatus}]`);
      if (pm10Val !== null) sensorData.push(`PM10:${pm10Val}[${pm10Status}]`);
      else sensorData.push(`PM10:N/A`);
      if (coVal !== null) sensorData.push(`CO:${coVal}[${coStatus}]`);
      else sensorData.push(`CO:N/A`);
      if (no2Val !== null) sensorData.push(`NO2:${no2Val}[${no2Status}]`);
      else sensorData.push(`NO2:N/A`);
      if (o3Val !== null) sensorData.push(`O3:${o3Val}[${o3Status}]`);
      else sensorData.push(`O3:N/A`);
      if (so2Val !== null) sensorData.push(`SO2:${so2Val}[${so2Status}]`);
      else sensorData.push(`SO2:N/A`);

      logToTerminal(`RX_DATA: ${data.city.name.substring(0, 15)}... | ${sensorData.join(' ')}`);

      // Update Chart
      const time = new Date().toLocaleTimeString();
      if (chart.data.labels.length > 15) {
        chart.data.labels.shift();
        chart.data.datasets[0].data.shift(); // PM2.5
        chart.data.datasets[1].data.shift(); // PM10
        chart.data.datasets[2].data.shift(); // CO
        chart.data.datasets[3].data.shift(); // NO2
        chart.data.datasets[4].data.shift(); // O3
        chart.data.datasets[5].data.shift(); // SO2
      }
      chart.data.labels.push(time);
      chart.data.datasets[0].data.push(pm25Val);                                    // PM2.5
      chart.data.datasets[1].data.push(pm10Val !== null ? pm10Val : null);         // PM10 (null shows as gap)
      chart.data.datasets[2].data.push(coVal !== null ? coVal : null);              // CO (null shows as gap)
      chart.data.datasets[3].data.push(no2Val !== null ? no2Val : null);           // NO2 (null shows as gap)
      chart.data.datasets[4].data.push(o3Val !== null ? o3Val : null);            // O3 (null shows as gap)
      chart.data.datasets[5].data.push(so2Val !== null ? so2Val : null);           // SO2 (null shows as gap)
      chart.update();
    }

    function toggleSidebar() {
      const sb = document.getElementById('sidebar');
      const btn = document.getElementById('toggleBtn');
      sb.classList.toggle('collapsed');
      if (sb.classList.contains('collapsed')) {
        btn.innerHTML = '<i class="fas fa-chevron-right"></i>'; btn.style.left = '0px';
      } else {
        btn.innerHTML = '<i class="fas fa-chevron-left"></i>'; btn.style.left = '320px';
      }
    }

    function highlightListItem(index) {
      document.querySelectorAll('.station-item').forEach(el => el.classList.remove('active'));
      const active = document.getElementById(`item-${index}`);
      if (active) active.classList.add('active');
    }

    function getStatusText(pm25) {
      // Using Assembly/C++ thresholds
      if (pm25 < PM_SAFE_LIMIT) return 'SAFE';
      if (pm25 < PM_HAZARD_LIMIT) return 'MODERATE';
      return 'HAZARDOUS';
    }

    function logToTerminal(text) {
      const term = document.getElementById('terminalOutput');
      const line = document.createElement('div');
      line.className = 'terminal-line';
      line.innerText = `> ${text}`;
      term.prepend(line);
      if (term.childElementCount > 6) term.lastChild.remove();
    }
  </script>
</body>

</html>